dnl Process this file with autoconf to produce a configure script.
AC_INIT(cgi/index.c)

AC_CANONICAL_SYSTEM

AM_INIT_AUTOMAKE(monolith, 1.0)
AM_CONFIG_HEADER(include/config.h)
AC_PREFIX_DEFAULT(/usr/bbs)

AC_ARG_WITH(mysql, [  --with-mysql            use mysql database system  [default=yes]
                          (requires mysql to be installed)],,with_mysql=yes)
AC_ARG_WITH(rating, [  --with-rating           use message rating system  [default=yes]
                          (allows users to rate messages)],,with_rating=yes)
AC_ARG_WITH(hero, [  --with-hero             include superhero toy  [default=yes]
                          (requires silly sysops)],,with_hero=yes)
AC_ARG_WITH(overview, [  --with-overview         give overview after configuring  [default=no]],,with_overview=no)

if test "x$with_mysql" != "xyes"; then
  with_mysql=no
fi
if test "x$with_rating" != "xyes"; then
  with_rating=no
fi
if test "x$with_hero" != "xyes"; then
  with_hero=no
fi
if test "x$with_overview" != "xyes"; then
  with_overview=no
fi

umask 002

dnl Checks for programs.
AC_PROG_AWK
AC_PROG_CC
AC_PROG_RANLIB
AC_PROG_INSTALL
AC_PROG_MAKE_SET

dnl GNU gettext add-ons
ALL_LINGUAS="fr en nl de"
AM_GNU_GETTEXT

dnl Check for awk/gawk - used to determine if we're linux or not.
AC_PATH_PROG(awk_path,awk,no)
AC_PATH_PROG(gawk_path,gawk,no)
AC_PATH_PROG(grep_path,grep,no)

dnl Checks for libraries.
dnl Replace `main' with a function in -lgdbm:
AC_CHECK_LIB(gdbm, gdbm_open)
AC_CHECK_LIB(crypt, crypt)
AC_CHECK_LIB(nsl, inet_ntoa)
AC_CHECK_LIB(socket, getpeername)

dnl Checks for header files.
AC_HEADER_DIRENT
AC_HEADER_STDC
AC_HEADER_SYS_WAIT
AC_CHECK_HEADERS(crypt.h fcntl.h sgtty.h sys/file.h sys/ioctl.h sys/time.h sys/utsname.h termio.h termios.h termbits.h asm/termbits.h unistd.h mysql.h)

dnl Checks for typedefs, structures, and compiler characteristics.
AC_C_CONST
AC_TYPE_OFF_T
AC_TYPE_PID_T
AC_TYPE_SIZE_T
AC_HEADER_TIME
AC_STRUCT_TM

dnl Checks for library functions.
AC_PROG_GCC_TRADITIONAL
AC_TYPE_SIGNAL
AC_FUNC_VPRINTF
AC_FUNC_STRFTIME
AC_FUNC_MMAP
AC_CHECK_FUNCS(uname gettimeofday gethostname mkdir regcomp socket putenv strcspn strdup strspn strstr)

dnl check if MAP_FAILED is defined...
if test "x$grep_path" != "xno" ; then
  AC_CHECK_HEADERS(sys/mman.h)
  if test "x$ac_cv_header_sys_mman_h" != "xno" ; then
    AC_DEFINE(HAVE_SYS_MMAN_H)
    if test -r /usr/include/sys/mman.h; then
      echo -n "checking whether sys/mman.h defines MAP_FAILED..."
      result=`grep MAP_FAILED /usr/include/sys/mman.h`
      if test "x$result" != "x"; then
        echo " yes"
        AC_DEFINE(HAVE_MAP_FAILED)
      else
        echo " no"
      fi
    fi
  fi
fi

dnl Do a bit of mysql checking.
if test "x$with_mysql" = "xyes" ; then
  echo -n "checking MySQL installation..."
  if test "x$ac_cv_header_mysql_h" = "xno" ; then
    echo " having another look"
    AC_CHECK_HEADERS(mysql/mysql.h)
    if test "x$ac_cv_header_mysql_mysql_h" = "xno" ; then
      echo " whoops!"
      echo
      echo "ARGH: Unable to locate mysql!"
      echo
      echo "Please install the MySQL database system, which is available for free from"
      echo "http://www.mysql.org/ and run this program again. If you do have MySQL in-"
      echo "stalled, check directory and file permissions, or create symbolic links so"
      echo "configure can find it."
      echo
      exit 0
    else
      AC_DEFINE(HAVE_MYSQL_MYSQL_H)
    fi
  else
    echo " rock!"
    AC_DEFINE(HAVE_MYSQL_H)
  fi
  AC_CHECK_LIB(mysqlclient, mysql_connect)
  AC_DEFINE(USE_MYSQL)
fi

dnl Use message rating system?
echo -n "checking whether to enable ratings..."
if test "x$with_rating" = "xyes"; then
  echo " yes"
  AC_DEFINE(USE_RATING)
else
  echo "no"
fi

dnl Use superhero generator?
echo -n "checking superhero powers..."
if test "x$with_hero" = "xyes"; then
  AC_DEFINE(SUPERHERO)
  echo " found in /dev/he-man"
else
  echo " need more spinach (sorry)"
fi

dnl Check if the proc-animal patch is installed.
echo -n "checking for proc-animal kernel patch..."
if test -r /proc/sys/kernel/name; then
    echo " yes"
    AC_DEFINE(HAVE_ANIMAL)
else
    echo " no"
fi

dnl Define LINUX if this is a linux system.
if test "x$gawk_path" != "xno" ; then
  os=`echo $target_os | gawk -F'-' '{print $1}'`
  echo -n "checking for sysinfo() call..."
  if test "x$os" = "xlinux" ; then
    AC_DEFINE(LINUX)
    echo " yes"
  else
    echo " no"
  fi
else
  if test "x$awk_path" != "xno" ; then
    os=`echo $target_os | awk -F'-' '{print $1}'`
    echo -n "checking for sysinfo() call..."
    if test "x$os" = "xlinux" ; then
      AC_DEFINE(LINUX)
      echo " yes"
    else
      echo " no"
    fi
  fi
fi

AC_OUTPUT(cgi/Makefile lib/Makefile daemons/Makefile src/Makefile \
     misc/Makefile shix/Makefile share/Makefile share/feelings/Makefile \
     share/loginscreens/Makefile web/Makefile web/engine/Makefile \
     web/pix/Makefile web/style/Makefile web/script/Makefile \
     web/sound/Makefile Makefile po/Makefile.in intl/Makefile)

if test "x$with_overview" = "xyes"; then
  dnl Give users a quick overview.
  echo
  echo -n "Please hit return to continue..."
  read ans
  clear
  
  echo "----------------------------------------------------------------------"
  echo "        You have set up your BBS with the following features:"
  echo "----------------------------------------------------------------------"
  echo
  echo "  * MySQL is installed and will be used."
  if test "x$with_rating" = "xyes"; then
    echo "  * Rating system is enabled."
  else
    echo "  * Rating system is disabled."
  fi
  if test "x$with_hero" = "xyes"; then
    echo "  * Superheroes can be generated."
  else
    echo "  * Superheroes can not be generated."
  fi
  if test "x$os" = "xlinux" ; then
    echo "  * Extended system info is available."
  else
    echo "  * Extended system info is not available."
  fi
fi
echo
if test "x$with_overview" = "xno"; then
  echo "----------------------------------------------------------------------"
fi
echo "Just run make and sit back whilst the BBS is compiled. After"
echo "compilation is finished, refer to the README file for details on"
echo "how to install the BBS on your machine. Note that you will need"
echo "root access to do this."
echo "----------------------------------------------------------------------"
echo
